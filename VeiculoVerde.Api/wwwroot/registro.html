<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Substituição</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Registrar Substituição de Veículo</h1>
        <form id="registroForm">
            <h2>Dados do Veículo a Combustão:</h2>
            <div>
                <label for="placaAntiga">Placa Veículo Combustão:</label>
                <input type="text" id="placaAntiga" name="placaVeiculoCombustao" required maxlength="10" placeholder="Ex: ABC1234">
            </div>
            <div>
                <label for="marcaAntiga">Marca Veículo Combustão:</label>
                <input type="text" id="marcaAntiga" name="marcaVeiculoCombustao" required placeholder="Ex: Fiat">
            </div>
            <div>
                <label for="modeloAntigo">Modelo Veículo Combustão:</label>
                <input type="text" id="modeloAntigo" name="modeloVeiculoCombustao" required placeholder="Ex: Palio">
            </div>
            <div>
                <label for="anoAntigo">Ano Fabricação Veículo Combustão:</label>
                <input type="number" id="anoAntigo" name="anoFabricacaoVeiculoCombustao" required min="1900" max="2025" placeholder="Ex: 2010">
            </div>
            <div>
                <label for="emissaoCO2Antiga">Emissão CO2 Anterior (kg/km):</label>
                <input type="number" step="0.01" id="emissaoCO2Antiga" name="emissaoCO2Anterior" required min="0" placeholder="Ex: 0.15">
            </div>
            <div>
                <label for="consumoCombustivelAntigo">Consumo Combustível Anterior (km/l):</label>
                <input type="number" step="0.01" id="consumoCombustivelAntigo" name="consumoCombustivelAnteriorKmPorLitro" required min="0" placeholder="Ex: 12.5">
            </div>

            <h2>Dados do Veículo Substituto:</h2>
            <div>
                <label for="tipoSubstituto">Tipo Veículo Substituto:</label>
                <select id="tipoSubstituto" name="tipoVeiculoSubstituto" required>
                    <option value="0">Carro Elétrico</option>
                    <option value="1">Moto Elétrica</option>
                    <option value="2">Bicicleta Elétrica</option>
                    <option value="3">Bicicleta Comum</option>
                </select>
            </div>
            <div>
                <label for="marcaSubstituto">Marca Veículo Substituto:</label>
                <input type="text" id="marcaSubstituto" name="marcaVeiculoSubstituto" required placeholder="Ex: Tesla">
            </div>
            <div>
                <label for="modeloSubstituto">Modelo Veículo Substituto:</label>
                <input type="text" id="modeloSubstituto" name="modeloVeiculoSubstituto" required placeholder="Ex: Model 3">
            </div>
            <div>
                <label for="emissaoCO2Nova">Emissão CO2 Nova (kg/km):</label>
                <input type="number" step="0.01" id="emissaoCO2Nova" name="emissaoCO2Nova" required min="0" placeholder="Ex: 0.01 (considerando energia renovável)">
            </div>
            <div>
                <label for="autonomiaSubstituto">Autonomia Veículo Substituto (km):</label>
                <input type="number" step="0.01" id="autonomiaSubstituto" name="autonomiaVeiculoSubstitutoKm" required min="0" placeholder="Ex: 400">
            </div>

            <h2>Localização e Data:</h2>
            <div>
                <label for="dataSubstituicao">Data da Substituição:</label>
                <input type="date" id="dataSubstituicao" name="dataSubstituicao" required>
            </div>
            <div>
                <label for="cep">CEP:</label>
                <input type="text" id="cep" name="cep" required maxlength="8" placeholder="Ex: 01000000">
            </div>
            <div>
                <label for="cidade">Cidade:</label>
                <input type="text" id="cidade" name="cidade" required placeholder="Ex: São Paulo">
            </div>
            <div>
                <label for="estado">Estado (UF):</label>
                <input type="text" id="estado" name="estado" required maxlength="2" placeholder="Ex: SP">
            </div>
            <div>
                <label for="pais">País:</label>
                <input type="text" id="pais" name="pais" value="Brasil" readonly>
            </div>
            <button type="submit">Registrar Substituição</button>
        </form>

        <div class="result-box" id="registroResult"></div>
        <div class="error-message" id="registroError"></div>
        <p><a href="index.html">Voltar ao Dashboard</a></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('dataSubstituicao').value = `${year}-${month}-${day}`;
        });

        document.getElementById('registroForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (key === 'emissaoCO2Anterior' || key === 'consumoCombustivelAnteriorKmPorLitro' ||
                    key === 'emissaoCO2Nova' || key === 'autonomiaVeiculoSubstitutoKm') {
                    data[key] = parseFloat(value);
                } else if (key === 'anoFabricacaoVeiculoCombustao' || key === 'tipoVeiculoSubstituto') {
                    data[key] = parseInt(value);
                } else {
                    data[key] = value;
                }
            });

            const cepInput = document.getElementById('cep');
            if (cepInput.value && !/^\d{8}$/.test(cepInput.value)) {
                document.getElementById('registroError').textContent = 'O CEP deve conter exatamente 8 dígitos numéricos.';
                document.getElementById('registroResult').innerHTML = '';
                return;
            }

            const estadoInput = document.getElementById('estado');
            if (estadoInput.value && !/^[A-Z]{2}$/.test(estadoInput.value.toUpperCase())) {
                document.getElementById('registroError').textContent = 'O Estado deve ser uma sigla de 2 letras (ex: SP).';
                document.getElementById('registroResult').innerHTML = '';
                return;
            }


            try {
                const response = await fetch('/api/VeiculoSubstituicao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const resultBox = document.getElementById('registroResult');
                const errorBox = document.getElementById('registroError');
                errorBox.textContent = '';

                if (response.ok) {
                    const result = await response.json();
                    resultBox.innerHTML = `
                            <h3>Substituição registrada com sucesso!</h3>
                            <p><strong>ID da Substituição:</strong> ${result.id}</p>
                            <p><strong>Redução Estimada de CO2:</strong> ${result.reducaoCO2Estimada ? result.reducaoCO2Estimada.toFixed(2).replace('.', ',') : '0,00'} kg</p>
                            <p><strong>Economia Estimada de Combustível:</strong> ${result.economiaCombustivelEstimada ? result.economiaCombustivelEstimada.toFixed(2).replace('.', ',') : '0,00'} litros</p>
                            <p>Os dados completos do registro estão no console (JSON).</p>
                        `;
                    console.log('Dados do registro:', result);
                    form.reset();
                } else {
                    const error = await response.json();
                    let errorMessage = `Erro ${response.status}: ${response.statusText}\n`;
                    if (error.errors) {
                        for (const key in error.errors) {
                            errorMessage += `• ${key}: ${error.errors[key].join(', ')}\n`;
                        }
                    } else if (error.detail) {
                        errorMessage += error.detail;
                    } else if (typeof error === 'string') {
                        errorMessage += error;
                    } else {
                        errorMessage += JSON.stringify(error, null, 2);
                    }
                    errorBox.textContent = errorMessage;
                    resultBox.innerHTML = '';
                }
            } catch (error) {
                document.getElementById('registroError').textContent = 'Erro de rede ou ao processar a resposta: ' + error.message;
                document.getElementById('registroResult').innerHTML = '';
            }
        });
    </script>
</body>
</html>