<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Impacto Ambiental</title>
    <script>
        const API_BASE_URL = "/api/ImpactoAmbiental";
    </script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <style>
        .hidden {
            display: none;
        }

        .api-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4">

    <!-- STATUS -->
    <div id="statusMessage" class="hidden text-sm p-3 rounded mb-4 font-semibold"></div>

    <!-- FORMULÁRIO DE REGISTRO -->
    <div id="register-view" class="view">
        <form id="registroForm" class="bg-white p-6 rounded shadow-md space-y-4 max-w-lg mx-auto">
            <h1 class="text-2xl font-bold mb-4 text-center">Registrar Impacto Ambiental</h1>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="input-cep" placeholder="CEP" class="border p-2 rounded" required />
                <input type="text" id="input-cidade" placeholder="Cidade" class="border p-2 rounded" required />
                <input type="text" id="input-estado" placeholder="Estado" class="border p-2 rounded" required />
                <input type="number" id="input-co2" placeholder="Redução CO2 (kg)" class="border p-2 rounded" min="0" step="0.01" required />
                <input type="number" id="input-combustivel" placeholder="Economia Combustível (litros)" class="border p-2 rounded" min="0" step="0.01" required />
                <input type="number" id="input-substituicoes" placeholder="Número de Substituições" class="border p-2 rounded" min="0" required />
            </div>

            <div class="text-center mt-4">
                <button id="addRegistroBtn" type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    Registrar Impacto
                </button>
            </div>

            <div class="text-center mt-4">
                <a href="analise.html" class="text-blue-500 hover:underline">Ir para Análise</a>
            </div>
        </form>
    </div>

    <!-- LISTA DE REGISTROS -->
    <div id="registro-list-container" class="max-w-3xl mx-auto mt-10">
        <div id="loadingMessage" class="text-center text-gray-500 hidden">Carregando registros...</div>
        <div id="registroList" class="space-y-4"></div>
    </div>

    <!-- SCRIPTS -->
    <script>
        const inputCEP = document.getElementById('input-cep');
        const inputCidade = document.getElementById('input-cidade');
        const inputEstado = document.getElementById('input-estado');
        const inputCO2 = document.getElementById('input-co2');
        const inputCombustivel = document.getElementById('input-combustivel');
        const inputSubstituicoes = document.getElementById('input-substituicoes');
        const statusMessage = document.getElementById('statusMessage');
        const loadingMessage = document.getElementById('loadingMessage');
        const registroForm = document.getElementById('registroForm');
        const registroList = document.getElementById('registroList');
        const addRegistroBtn = document.getElementById('addRegistroBtn');

        let registros = [];

        function changeView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.style.display = 'block';
            }
        }

        function displayStatus(message, type = 'red') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-yellow-500', 'api-error');

            if (message.includes("Falha na conexão com a API") || type === 'red') {
                statusMessage.classList.add('api-error');
            } else if (type === 'green') {
                statusMessage.classList.add('bg-green-500', 'text-white');
            } else if (type === 'yellow') {
                statusMessage.classList.add('bg-yellow-500', 'text-gray-800');
            }

            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }

        function clearForm() {
            registroForm.reset();
        }

        async function fetchRegistros() {
            loadingMessage.classList.remove('hidden');
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                const response = await fetch(API_BASE_URL, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                return await response.json();

            } catch (error) {
                displayStatus("Falha na conexão com a API. Verifique o Docker em http://localhost:8080.", 'red');
                return [];
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        async function addRegistroToDb(novoRegistro) {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(novoRegistro)
            });

            if (!response.ok) {
                const errorText = await response.text();
                let message = `Falha ao registrar impacto. Status: ${response.status}.`;
                try {
                    const errorJson = JSON.parse(errorText);
                    if (errorJson.title) message += ` ${errorJson.title}`;
                    else if (errorJson.errors) message += " " + Object.values(errorJson.errors).flat().join(", ");
                } catch (e) {
                    message += ` Detalhes: ${errorText.substring(0, 100)}...`;
                }
                throw new Error(message);
            }

            return response.json();
        }

        async function deleteRegistroFromDb(id) {
            const response = await fetch(`${API_BASE_URL}/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Falha ao deletar registro. Status: ${response.status}.`);
            }

            return true;
        }

        async function addRegistro(e) {
            e.preventDefault();

            const cep = inputCEP.value.trim();
            const cidade = inputCidade.value.trim();
            const estado = inputEstado.value.trim();
            const reducaoCO2 = parseFloat(inputCO2.value);
            const economiaCombustivel = parseFloat(inputCombustivel.value);
            const numeroSubstituicoes = parseInt(inputSubstituicoes.value, 10);

            if (!cep || !cidade || !estado || isNaN(reducaoCO2) || isNaN(economiaCombustivel) || isNaN(numeroSubstituicoes)) {
                displayStatus("Por favor, preencha todos os campos corretamente.", 'yellow');
                return;
            }
            if (reducaoCO2 < 0 || economiaCombustivel < 0 || numeroSubstituicoes < 0) {
                displayStatus("As métricas não podem ser negativas.", 'yellow');
                return;
            }

            const novoRegistro = {
                CEP: cep,
                Cidade: cidade,
                Estado: estado,
                ReducaoCO2TotalKg: reducaoCO2,
                EconomiaCombustivelTotalLitros: economiaCombustivel,
                NumeroSubstituicoes: numeroSubstituicoes,
                DataAnalise: new Date().toISOString()
            };

            try {
                addRegistroBtn.disabled = true;
                addRegistroBtn.textContent = "Registrando na API...";

                await addRegistroToDb(novoRegistro);
                await initializeApp();

                clearForm();
                displayStatus("Registro de Impacto criado com sucesso!", 'green');
            } catch (error) {
                displayStatus(error.message, 'red');
            } finally {
                addRegistroBtn.disabled = false;
                addRegistroBtn.textContent = "Registrar Impacto";
            }
        }

        async function deleteRegistro(registroId) {
            try {
                await deleteRegistroFromDb(registroId);
                await initializeApp();
                displayStatus("Registro de impacto removido com sucesso.", 'green');
            } catch (error) {
                displayStatus(`Erro ao deletar registro: ${error.message}`, 'red');
            }
        }

        function renderRegistros() {
            registroList.innerHTML = '';

            if (registros.length === 0) {
                registroList.innerHTML = `<p class="text-gray-500 text-center p-8 bg-white rounded-xl shadow-md">
                        Nenhum registro de impacto encontrado. Adicione a primeira análise ou verifique a conexão com a API.
                    </p>`;
                return;
            }

            const sorted = [...registros].sort((a, b) => new Date(b.DataAnalise) - new Date(a.DataAnalise));

            sorted.forEach(registro => {
                const registroElement = document.createElement('div');
                const co2 = registro.ReducaoCO2TotalKg?.toFixed(2) ?? '0.00';
                const combustivel = registro.EconomiaCombustivelTotalLitros?.toFixed(2) ?? '0.00';
                const data = new Date(registro.DataAnalise).toLocaleDateString('pt-BR', { dateStyle: 'short' });

                registroElement.className = 'bg-white p-5 rounded-xl border-l-4 border-blue-500 shadow-md';
                registroElement.innerHTML = `
                        <div class="flex justify-between items-start mb-3 border-b pb-2">
                            <div class="text-lg font-bold text-gray-800 flex flex-col sm:flex-row sm:items-center">
                                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded mr-2 mb-1 sm:mb-0 whitespace-nowrap">
                                    ${registro.Cidade} - ${registro.Estado}
                                </span>
                                <span class="text-sm font-normal text-gray-500">${data}</span>
                            </div>
                            <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full" data-id="${registro.Id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div><p class="text-2xl font-bold">${co2}</p><p class="text-xs text-gray-500">Redução CO2 (Kg)</p></div>
                            <div><p class="text-2xl font-bold">${combustivel}</p><p class="text-xs text-gray-500">Economia Comb. (L)</p></div>
                            <div><p class="text-2xl font-bold">${registro.NumeroSubstituicoes}</p><p class="text-xs text-gray-500">Substituições</p></div>
                        </div>
                        <p class="mt-3 text-right text-xs text-gray-400">ID: ${registro.Id} - CEP: ${registro.CEP}</p>
                    `;
                registroElement.querySelector('.delete-btn').addEventListener('click', () => {
                    deleteRegistro(registro.Id);
                });
                registroList.appendChild(registroElement);
            });
        }

        async function initializeApp() {
            changeView('register-view');
            const fetched = await fetchRegistros();
            registros = fetched;
            renderRegistros();
        }

        registroForm.addEventListener('submit', addRegistro);
        window.onload = initializeApp;
    </script>
</body>
</html>
